{% extends "layouts/base.html" %}


{% block content %}



<!-- Área de búsqueda -->
<div class="row mb-3" id="acordeon">
  <div class="col-12">
    <div class="card-body">
      <div class="accordion app-accordion accordion-primary">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#filter_area"
              aria-expanded="true" aria-controls="filter_area">
                Personaliza y filtra las oportunidades de inversión inmobiliaria
            </button>
          </h2>
          <!-- incluir show como clase del id filter_area si queremos que aparezca sin colapsar -->
          <div id="filter_area" class="accordion-collapse collapse" data-bs-parent="#acordeon">
            <div class="accordion-body">
              <!-- filter_form -->
              <form name="ftr_data_form" class="app-form">
                <div class="row">
                  <div class="col-12 mb-2">
                    <p>Descubre las mejores oportunidades de inversión personalizando tus filtros de búsqueda y encuentra las
                      propiedades que mejor se adaptan a tus objetivos.</p>
                  </div>
                  <div class="col-sm-6">
                    <div class="mb-3">
                      <label class="form-label">Que incluyan el siguiente texto</label>
                      <input name="ftr_text" type="text" class="form-control" placeholder="Introduzca un texto">
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="mb-3">
                      <label class="form-label">Distrito</label>
                      <select name="ftr_district" class="form-select">
                        <option value="" selected>Incluir Todos</option>
                        {% for district in districts %}
                        <option value="{{ district.DISTRITO }}">{{ district.DISTRITO }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
              
                  <div class="col-sm-6 ">
                    <div>
                      <label class="form-label mb-3" style="padding-bottom:25px">Precio de compra</label>
                      <div class="mt-3" id="buy_price-slider"></div>
                      <input  name="ftr_buy_price_min" type="hidden" id="buy_price-min">
                      <input name="ftr_buy_price_max" type="hidden" id="buy_price-max">
                      <span id="buy_price-display"></span>
                    </div>
                  </div>
              
              
              
                </div>
              
              </form>
              <!-- /filter_form -->
            
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#info_area"
              aria-expanded="true" aria-controls="info_area">
                Información adicional
            </button>
          </h2>

          <div id="info_area" class="accordion-collapse collapse" data-bs-parent="#acordeon">
            <div class="accordion-body">
              <p>En esta sección encontrarás un listado de propiedades inmobiliarias que cumplen con los criterios de
                búsqueda establecidos. Puedes personalizar los filtros para ajustar la búsqueda a tus necesidades.</p>
              <p>Para cada propiedad, se muestra el distrito, título, precio de compra, superficie, enlace para visitar y
                estimación de facturación anual.</p>
              <p>Utiliza los filtros para encontrar las mejores oportunidades de inversión inmobiliaria que se adapten a tus
                objetivos financieros.</p> 
              <p>Leyenda:</p>
              <ul>
                <li><strong>EUR</strong>: Valor de adquisición en Euros de la vivienda.</li>
                <li><strong>ADR</strong>: Average Daily Rate o Tarifa Media Diaria.</li>
                <li><strong>ARR</strong>: Annual Recurring Revenue o Ingresos Recurrentes Anuales.</li>
                <li><strong>ROI</strong>: Return on Investment o Retorno de la Inversión.</li>

              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- /Área de búsqueda -->

            
            <!-- Data Table start -->
            <div class="row">
                <!-- Default Datatable start -->
                <div class="col-12">
                  <div class="card ">
                    <!-- <div class="card-header">
                      <h5>Card Title</h5>
                      <p>DataTables has most features enabled by default, so all you need to do to use it with your own
                        tables is to call the construction function: <code>$().DataTable();</code>. </p>
                    </div> -->
                    <div class="card-body p-0">
                      <div class="app-datatable-default overflow-auto">
                        <table id="tablelist" class="display app-data-table default-data-table">
                          <thead>
                            <tr>
                              <th>Id</th>
                              <th>Distrito</th>
                              <th>Título</th>
                              <th>Superficie</th>
                              <th>Ver</th>
                              <th>EUR</th>
                              <th>ADR</th>
                              <th>ARR</th>
                            </tr>
                          </thead>
                          <tbody>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Default Datatable end -->
                
              </div>
              <!-- Data Table end -->



<script>
  $(document).ready(function () {

    const form = document.forms['ftr_data_form'];

    $('#tablelist').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '{{url_for("idealista_controller.datalist")}}',
        type: "POST",
        data: function(d) {
          // const form = document.forms['ftr_data_form'];
            d.ftr_text = form.querySelector('input[name="ftr_text"]').value;
            d.ftr_district = form.querySelector('select[name="ftr_district"]').value;
            d.ftr_buy_price_min = form.querySelector('input[name="ftr_buy_price_min"]').value;
            d.ftr_buy_price_max = form.querySelector('input[name="ftr_buy_price_max"]').value;
        }
      },

      language: {
        url: "/static/lang/datatables_es-ES.json",
        type: "POST"
      },
      columns: [
        { data: 'id' },
        { data: 'DISTRITO' },
        { data: 'title' },

        { data: 'built_area' },
        { data: 'link',
          render: function (data, type, row) {
            return '<a type="button" class="btn btn-light-primary icon-btn b-r-4" href="' + data + '" target="_blank"><i class="ti ti-hand-click"></i></a>';
          }
         },
        { 
          data: 'price',
            render: function (data, type, row) {
            if (data == null) return '';
            let number = Number(data);
            if (isNaN(number)) return data;
            return number.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
            }
        },         
        { data: 'PRICE_PER_NIGHT',
            render: function (data, type, row) {
            if (data == null) return '';
            let number = Number(data);
            if (isNaN(number)) return data;
            return number.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
            }
         },
        { data: 'revenue',
            render: function (data, type, row) {
            if (data == null) return '';
            let number = Number(data);
            if (isNaN(number)) return data;
            return number.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
            }
         },


      ]
    });


    $(form).on('change input', 'input, select', function() {
      $('#tablelist').DataTable().ajax.reload();
    });




  const slider = document.getElementById('buy_price-slider');

  noUiSlider.create(slider, {
    start: [0, {{ max_inv_budget}}],
    connect: true,
    range: {
      'min': 0,
      'max': {{ max_price }}
    },
    tooltips: true,
    format: {
      to: value => Math.round(value) + ' €',
      from: value => Number(value.replace(' €', ''))
    }
  });

    slider.noUiSlider.on('update', function (values, handle) {
      const min = values[0].replace(' €', '');
      const max = values[1].replace(' €', '');
      document.getElementById('buy_price-min').value = min;
      document.getElementById('buy_price-max').value = max;
      $(form).find('input[name="ftr_buy_price_min"], input[name="ftr_buy_price_max"]').trigger('change');
      // Formatear con separador de miles
      const minFormatted = Number(min).toLocaleString('es-ES');
      const maxFormatted = Number(max).toLocaleString('es-ES');
      document.getElementById('buy_price-display').innerText = `De ${minFormatted} € a ${maxFormatted} €`;
    });



  });







</script>

              {% endblock %}  


